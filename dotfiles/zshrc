# Powerlevel10k instant prompt
if [[ -r "$XDG_CACHE_HOME/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "$XDG_CACHE_HOME/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# miniconda3
# export PATH="$HOME/miniconda3/bin:$PATH"  # commented out by conda initialize

# Ruby
export PATH="/usr/local/opt/ruby/bin:$PATH"
# Clangd
export PATH="/usr/local/opt/llvm/bin:$PATH"

### Start of Zinit's installer chunk
source "$HOME/.zinit/bin/zinit.zsh"
# autoload -Uz _zinit
#  (( ${+_comps} )) && _comps[zinit]=_zinit

# ZSH_AUTOSUGGEST
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20
ZSH_AUTOSUGGEST_USE_ASYNC=1
ZSH_AUTOSUGGEST_MANUAL_REBIND=1
ZSH_AUTOSUGGEST_COMPLETION_IGNORE='( |man |pikaur -S )*'
# "ctrl + →" doing the forward-word, 
# and "→" getting to the end of prompt line

# forgit
forgit_add=fga
forgit_diff=fgd
forgit_log=fglo
forgit_ignore=fgi
forgit_stash_show=fgss
FORGIT_FZF_DEFAULT_OPTS="--height '80%'"

# fzf_tab
FZF_TAB_COMMAND=(
    fzf
    --ansi   # 启用 ANSI 颜色代码的支持，对于显示分组来说是必需的
    --border
    --height 80%
    --expect='$continuous_trigger' # 连续补全
    '--color=hl:$(( $#headers == 0 ? 108 : 255 ))'
    --nth=2,3 --delimiter='\x00'  # 不搜索前缀
    --layout=reverse
    --bind alt-p:preview-up,alt-n:preview-down
    --bind ctrl-u:half-page-up
    --bind ctrl-d:half-page-down
    --bind alt-a:select-all,ctrl-r:toggle-all
    --bind ctrl-s:toggle-sort
    --tiebreak=begin
    --multi
    --cycle
    '--query=$query'   # $query 将在运行时扩展为查询字符串
    '--header-lines=$#headers' # $#headers 将在运行时扩展为组标题数目
)
zstyle ':fzf-tab:*' command $FZF_TAB_COMMAND
local extract="
# trim input(what you select)
local in=\${\${\"\$(<{f})\"%\$'\0'*}#*\$'\0'}
# get ctxt for current completion(some thing before or after the current word)
local -A ctxt=(\"\${(@ps:\2:)CTXT}\")
# real path
local realpath=\${ctxt[IPREFIX]}\${ctxt[hpre]}\$in
realpath=\${(Qe)~realpath}
"
zstyle ':fzf-tab:*' single-group ''
zstyle ':fzf-tab:*' continuous-trigger '/'
zstyle ':fzf-tab:complete:_zlua:*' query-string input
zstyle ':fzf-tab:complete:kill:argument-rest' extra-opts --preview=$extract'ps --pid=$in[(w)1] -o cmd --no-headers -w -w' --preview-window=down:3:wrap
# zstyle ':fzf-tab:complete:cd:*' extra-opts --preview=$extract'exa -1 --color=always $realpath'

# Zsh-you-should-use
YSU_MODE=ALL
# YSU_MODE=BESTMATCH
YSU_MESSAGE_POSITION="after"
YSU_MESSAGE_FORMAT="$(tput setaf 1)Hey! I found this %alias_type for %command: %alias$(tput sgr0)"

# Z.lua
_ZL_ECHO=1  # display new directory name after cd
_ZL_MATCH_MODE=1  # enhanced matching
_ZL_ADD_ONCE=1  # only add path if the $PWD is changed

# Vi Mode
# Mode-sensitive cursor styling
MODE_CURSOR_VIINS="#00ff00 blinking bar"
MODE_CURSOR_REPLACE="$MODE_CURSOR_VIINS #ff0000"
MODE_CURSOR_VICMD="green block"
MODE_CURSOR_SEARCH="#ff00ff steady underline"
MODE_CURSOR_VISUAL="$MODE_CURSOR_VICMD steady bar"
MODE_CURSOR_VLINE="$MODE_CURSOR_VISUAL #00ffff"
# Mode in prompt
MODE_INDICATOR_VIINS='%F{15}<%F{8}INSERT<%f'
MODE_INDICATOR_VICMD='%F{10}<%F{2}NORMAL<%f'
MODE_INDICATOR_REPLACE='%F{9}<%F{1}REPLACE<%f'
MODE_INDICATOR_SEARCH='%F{13}<%F{5}SEARCH<%f'
MODE_INDICATOR_VISUAL='%F{12}<%F{4}VISUAL<%f'
MODE_INDICATOR_VLINE='%F{12}<%F{4}V-LINE<%f'

# plugins
zinit light-mode for \
    skywind3000/z.lua \
    wfxr/forgit \
    MichaelAquilina/zsh-you-should-use \
    olets/zsh-abbr \
    softmoth/zsh-vim-mode \
#     Aloxaf/gencomp \

zinit light-mode for \
    blockf \
        zsh-users/zsh-completions \
        hlissner/zsh-autopair \
    atclone="dircolors -b LS_COLORS > c.zsh" atpull='%atclone' pick='c.zsh' \
        trapd00r/LS_COLORS

# OMZ
zinit wait lucid for \
    OMZP::git-extras \
    OMZP::git \
    OMZL::clipboard.zsh

zinit ice mv=":cht.sh -> cht.sh" atclone="chmod +x cht.sh" as="program"
zinit snippet https://cht.sh/:cht.sh

zinit ice mv=":zsh -> _cht" as="completion"
zinit snippet https://cheat.sh/:zsh

zinit as="completion" for \
    OMZP::docker/_docker \
    OMZP::fd/_fd \
    OMZP::cargo/_cargo \
    OMZP::rust/_rust \
    esc/conda-zsh-completion

zinit svn for \
    OMZP::pip \
    OMZP::extract \

# special plugins
zpcompinit; zpcdreplay

for config in $XDG_CONFIG_HOME/zsh/*.zsh; do
    source $config
done
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

zinit light-mode for \
    Aloxaf/fzf-tab \
    zdharma/fast-syntax-highlighting \
    zsh-users/zsh-autosuggestions \
    OMZP::colored-man-pages

bindkey '^ ' autosuggest-execute

# themes
: ${THEME:=p10k}

case $THEME in
    starship)
        eval "$(starship init zsh)" || logwarn "failed loading starship."
        ;;
    p10k)
        source $XDG_CONFIG_HOME/zsh/themes/p10k.zsh
        zinit ice depth=1; zinit light romkatv/powerlevel10k
        ;;
esac

### End of Zinit's installer chunk

# exec -l fish "$@"
